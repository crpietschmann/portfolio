---
layout: post
title: "VB.NET: Syntax Highlighting in a RichTextBox control"
date: 2005-05-24 21:18:00 -0500
comments: true
published: true
categories: ["blog", "archives"]
tags: ["vb.net", "Win32API"]
redirect_from: 
  - /post/2005/05/24/VBNET-Syntax-Highlighting-in-a-RichTextBox-control
  - /post/2005/05/24/vbnet-syntax-highlighting-in-a-richtextbox-control
---
<!-- more -->
<p>This last weekend I expirimented a little bit&nbsp;with extending the functionality of the RichTextBox control. Below you'll find an example of a small class that enherits from the RichTextBox control and&nbsp;allows you to implement syntax highlighting (with the use of a couple Win32 API call to smooth over the process of course.) The code pretty much speaks for itself.</p>
<p>&nbsp;</p>
<p><span>Public</span><span> </span><span>Class</span><span> SyntaxRTB</span></p>
<p><span>&nbsp;&nbsp;&nbsp;Inherits</span><span> System.Windows.Forms.RichTextBox<br /> </span><span><br /> &nbsp;&nbsp;&nbsp;Private</span><span> </span><span>Declare</span><span> </span><span>Function</span><span> SendMessage </span><span>Lib</span><span> "user32" </span><span>Alias</span><span> "SendMessageA" _<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>(</span><span>ByVal</span><span> hWnd </span><span>As</span><span> IntPtr, </span><span>ByVal</span><span> wMsg </span><span>As</span><span> </span><span>Integer</span><span>, </span><span>ByVal</span><span> wParam </span><span>As</span><span> </span><span>Integer</span><span>, </span><span>ByVal </span><span>lParam </span><span>As</span><span> </span><span>Integer</span><span>) </span><span>As</span><span> </span><span>Integer</span></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p><span>&nbsp;&nbsp;&nbsp;Private</span><span> </span><span>Declare</span><span> </span><span>Function</span><span> LockWindowUpdate </span><span>Lib</span><span> "user32" (</span><span>ByVal</span><span> hWnd </span><span>As</span><span> </span><span>Integer</span><span>) </span><span>As</span><span> </span><span>Integer<br /> <br /> </span><span>&nbsp;&nbsp;&nbsp;Private</span><span> _SyntaxHighlight_CaseSensitive </span><span>As</span><span> </span><span>Boolean</span><span> = </span><span>False<br /> <br /> </span><span>&nbsp;&nbsp;&nbsp;Private</span><span> Words </span><span>As</span><span> </span><span>New</span><span> DataTable<br /> <br /> </span><span>&nbsp;&nbsp;&nbsp;'Contains Windows Messages for the SendMessage API call<br /> </span><span>&nbsp;&nbsp;&nbsp;Private</span><span> </span><span>Enum</span><span> EditMessages<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LineIndex = 187<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LineFromChar = 201<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GetFirstVisibleLine = 206<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CharFromPos = 215<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PosFromChar = 1062<br /> </span><span>&nbsp;&nbsp;&nbsp;End</span><span> </span><span>Enum</span></p>
<p>&nbsp;</p>
<p><span>&nbsp;&nbsp;&nbsp;Protected</span><span> </span><span>Overrides</span><span> </span><span>Sub</span><span> OnTextChanged(</span><span>ByVal</span><span> e </span><span>As</span><span> System.EventArgs)<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ColorVisibleLines()<br /> &nbsp;&nbsp;&nbsp;</span><span>End</span><span> </span><span>Sub</span></p>
<p>&nbsp;</p>
<p><span>&nbsp;&nbsp;&nbsp;Public</span><span> </span><span>Sub</span><span> ColorRtb()<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Dim</span><span> FirstVisibleChar </span><span>As</span><span> </span><span>Integer<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Dim</span><span> i </span><span>As</span><span> </span><span>Integer</span><span> = 0<br /> <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>While</span><span> i &lt; </span><span>Me</span><span>.Lines.Length<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FirstVisibleChar = GetCharFromLineIndex(i)<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ColorLineNumber(i, FirstVisibleChar)<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i += 1<br /> </span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;End</span><span> </span><span>While<br /> &nbsp;&nbsp;&nbsp;</span><span>End</span><span> </span><span>Sub</span></p>
<p>&nbsp;</p>
<p><span>&nbsp;&nbsp;&nbsp;Public</span><span> </span><span>Sub</span><span> ColorVisibleLines()<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Dim</span><span> FirstLine </span><span>As</span><span> </span><span>Integer</span><span> = FirstVisibleLine()<br /> </span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Dim</span><span> LastLine </span><span>As</span><span> </span><span>Integer</span><span> = LastVisibleLine()<br /> </span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Dim</span><span> FirstVisibleChar </span><span>As</span><span> </span><span>Integer<br /> <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>If</span><span> (FirstLine = 0) </span><span>And</span><span> (LastLine = 0) </span><span>Then<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>'If there is no text it will error, so exit the sub<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Exit</span><span> </span><span>Sub<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Else<br /> </span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;While</span><span> FirstLine &lt; LastLine<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FirstVisibleChar = GetCharFromLineIndex(FirstLine)<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ColorLineNumber(FirstLine, FirstVisibleChar)<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FirstLine += 1<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>End</span><span> </span><span>While<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>End</span><span> </span><span>If<br /> <br /> &nbsp;&nbsp;&nbsp;</span><span>End</span><span> </span><span>Sub</span></p>
<p>&nbsp;</p>
<p><span>&nbsp;&nbsp;&nbsp;Public</span><span> </span><span>Sub</span><span> ColorLineNumber(</span><span>ByVal</span><span> LineIndex </span><span>As</span><span> </span><span>Integer</span><span>, </span><span>ByVal</span><span> lStart </span><span>As</span><span> </span><span>Integer</span><span>)<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Dim</span><span> i </span><span>As</span><span> </span><span>Integer</span><span> = 0<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Dim</span><span> Instance </span><span>As</span><span> </span><span>Integer<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Dim</span><span> LeadingChar, TrailingChar </span><span>As</span><span> </span><span>String<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Dim</span><span> SelectionAt </span><span>As</span><span> </span><span>Integer</span><span> = </span><span>Me</span><span>.SelectionStart<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Dim</span><span> MyRow </span><span>As</span><span> DataRow<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Dim</span><span> Line() </span><span>As</span><span> </span><span>String</span><span>, MyI </span><span>As</span><span> </span><span>Integer</span><span>, MyStr </span><span>As</span><span> </span><span>String<br /> <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>' Lock the update<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>LockWindowUpdate(</span><span>Me</span><span>.Handle.ToInt32)<br /> <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MyI = lStart<br /> <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>If</span><span> CaseSensitive </span><span>Then<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Line = Split(</span><span>Me</span><span>.Lines(LineIndex).ToString, " ")<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Else<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Line = Split(</span><span>Me</span><span>.Lines(LineIndex).ToLower, " ")<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>End</span><span> </span><span>If<br /> <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>For</span><span> </span><span>Each</span><span> MyStr </span><span>In</span><span> Line<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Me</span><span>.SelectionStart = MyI<br /> </span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Me</span><span>.SelectionLength = MyStr.Length<br /> <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>If</span><span> Words.Rows.Contains(MyStr) </span><span>Then<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>MyRow = Words.Rows.Find(MyStr)<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>If</span><span> (</span><span>Not</span><span> CaseSensitive) </span><span>Or</span><span> (CaseSensitive </span><span>And</span><span> MyRow("Word") = MyStr) </span><span>Then<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Me</span><span>.SelectionColor = Color.FromName(MyRow("Color"))<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>End</span><span> </span><span>If<br /> </span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Else<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Me</span><span>.SelectionColor = Color.Black<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>End</span><span> </span><span>If<br /> <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>MyI += MyStr.Length + 1<br /> </span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Next<br /> </span><span><br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' Restore the selectionstart<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Me</span><span>.SelectionStart = SelectionAt<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Me</span><span>.SelectionLength = 0<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Me</span><span>.SelectionColor = Color.Black<br /> <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>' Unlock the update<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>LockWindowUpdate(0)<br /> &nbsp;&nbsp;&nbsp;</span><span>End</span><span> </span><span>Sub</span></p>
<p>&nbsp;</p>
<p><span>&nbsp;&nbsp;&nbsp;Public</span><span> </span><span>Function</span><span> GetCharFromLineIndex(</span><span>ByVal</span><span> LineIndex </span><span>As</span><span> </span><span>Integer</span><span>) </span><span>As</span><span> </span><span>Integer<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Return</span><span> SendMessage(</span><span>Me</span><span>.Handle, EditMessages.LineIndex, LineIndex, 0)<br /> &nbsp;&nbsp;&nbsp;</span><span>End</span><span> </span><span>Function</span></p>
<p>&nbsp;</p>
<p><span>&nbsp;&nbsp;&nbsp;Public</span><span> </span><span>Function</span><span> FirstVisibleLine() </span><span>As</span><span> </span><span>Integer<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Return</span><span> SendMessage(</span><span>Me</span><span>.Handle, EditMessages.GetFirstVisibleLine, 0, 0)<br /> &nbsp;&nbsp;&nbsp;</span><span>End</span><span> </span><span>Function</span></p>
<p>&nbsp;</p>
<p><span>&nbsp;&nbsp;&nbsp;Public</span><span> </span><span>Function</span><span> LastVisibleLine() </span><span>As</span><span> </span><span>Integer<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Dim</span><span> LastLine </span><span>As</span><span> </span><span>Integer</span><span> = FirstVisibleLine() + (</span><span>Me</span><span>.Height / </span><span>Me</span><span>.Font.Height)<br /> <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>If</span><span> LastLine &gt; </span><span>Me</span><span>.Lines.Length </span><span>Or</span><span> LastLine = 0 </span><span>Then<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>LastLine = </span><span>Me</span><span>.Lines.Length<br /> </span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;End</span><span> </span><span>If<br /> <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Return</span><span> LastLine<br /> &nbsp;&nbsp;&nbsp;</span><span>End</span><span> </span><span>Function</span></p>
<p>&nbsp;</p>
<p><span>&nbsp;&nbsp;&nbsp;Public</span><span> </span><span>Sub</span><span> </span><span>New</span><span>()<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Dim</span><span> MyRow </span><span>As</span><span> DataRow<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Dim</span><span> arrKeyWords() </span><span>As</span><span> </span><span>String</span><span>, strKW </span><span>As</span><span> </span><span>String<br /> <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Me</span><span>.AcceptsTab = </span><span>True<br /> <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>''Load all the keywords and the colors to make them&nbsp;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Words.Columns.Add("Word")<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Words.PrimaryKey = </span><span>New</span><span> DataColumn() {Words.Columns(0)}<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Words.Columns.Add("Color")<br /> <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;arrKeyWords = </span><span>New</span><span> </span><span>String</span><span>() {"select", "insert", "delete", _<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"truncate", "from", "where", "into", "inner", "update", _<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"outer", "on", "is", "declare", "set", "use", "values", "as", _<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"order", "by", "drop", "view", "go", "trigger", "cube", _<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"binary", "varbinary", "image", "char", "varchar", "text", _<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"datetime", "smalldatetime", "decimal", "numeric", "float", _<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"real", "bigint", "int", "smallint", "tinyint", "money", _<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"smallmoney", "bit", "cursor", "timestamp", "uniqueidentifier", _<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"sql_variant", "table", "nchar", "nvarchar", "ntext", "left", _<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"right", "like","and","all","in","null","join","not","or"}<br /> <br /> </span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;For</span><span> </span><span>Each</span><span> strKW </span><span>In</span><span> arrKeyWords<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MyRow = Words.NewRow()<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MyRow("Word") = strKW<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MyRow("Color") = Color.LightCoral.Name<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Words.Rows.Add(MyRow)<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Next<br /> <br /> &nbsp;&nbsp;&nbsp;</span><span>End</span><span> </span><span>Sub</span></p>
<p>&nbsp;</p>
<p><span>&nbsp;&nbsp;&nbsp;Public</span><span> </span><span>Property</span><span> CaseSensitive() </span><span>As</span><span> </span><span>Boolean<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Get<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Return</span><span> _SyntaxHighlight_CaseSensitive<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>End</span><span> </span><span>Get<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Set</span><span>(</span><span>ByVal</span><span> Value </span><span>As</span><span> </span><span>Boolean</span><span>)<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_SyntaxHighlight_CaseSensitive = Value<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>End</span><span> </span><span>Set<br /> </span><span>&nbsp;&nbsp;&nbsp;End</span><span> </span><span>Property</span></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p><span>End</span><span> </span><span>Class</span>&nbsp;&nbsp;&nbsp;</p>
<p>&nbsp;</p>
<p><strong>Update July 8th, 2008:</strong> Here's a link that shows a couple tips that may help in writing your own Syntax Highlighting RichTextBox control:</p>
<p><a href="http://codebetter.com/blogs/patricksmacchia/archive/2008/07/07/some-richtextbox-tricks.aspx">http://codebetter.com/blogs/patricksmacchia/archive/2008/07/07/some-richtextbox-tricks.aspx</a></p>
