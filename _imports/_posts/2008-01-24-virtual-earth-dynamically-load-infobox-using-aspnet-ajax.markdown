---
layout: post
blogengineid: 6271e9a0-4100-4919-af08-bd31ededb45b
title: "Virtual Earth: Dynamically Load InfoBox Using ASP.NET AJAX"
date: 2008-01-24 12:13:00 -0600
comments: true
published: true
categories: ["blog", "archives"]
tags: ["Bing Maps"]
redirect_from: 
  - /post/2008/01/24/Virtual-Earth-Dynamically-Load-InfoBox-Using-ASPNET-AJAX
  - /post/2008/01/24/virtual-earth-dynamically-load-infobox-using-aspnet-ajax
  - /post.aspx?id=6271e9a0-4100-4919-af08-bd31ededb45b
---
<!-- more -->
<p>Loading alot of pushpins on the map can slow down your page in two ways: 1) Page load times can be slowed down, and 2) loading pushpins via ajax can be slow. To improve the performance (as in download and database query times)&nbsp;of loading pushpins on the map, you can load the Pushpin Shapes Title and Description on the fly. This allows you to only load the Pushpins Title and Description as it's needed, thus reducing the amount of data you need to send down to the client when initially loading your pushpins.</p>
<h3>Dynamically Load InfoBox Title and Description using ASP.NET AJAX</h3>
<p><strong>Step 1:</strong> When adding Pushpins to the map, use the following format when setting thier Titles: "LOAD:{0}". Replace the "{0}" with a unique ID representing that Pushpin.</p>
<p><span style="color: #0000ff; font-size: x-small;">
<p>var<span style="font-size: x-small;"> s = </span><span style="color: #0000ff; font-size: x-small;">new</span><span style="font-size: x-small;"> VEShape(VEShapeType.Pushpin, map.GetCenter());<br /> s.Title = </span><span style="color: #a31515; font-size: x-small;">"LOAD:15"</span><span style="font-size: x-small;">;<br /> map.AddShape(s);</span></p>
</span></p>
<p><strong>Step 2: </strong>Create the GetInfoBoxData Page Method in the page that we'll call using Ajax. Also create a simple InfoBoxData class in the page; we'll use this class to more easily pass both the Title and Description down to the client.</p>
<p><span style="font-size: x-small;">
<p>[<span style="color: #2b91af; font-size: x-small;">WebMethod</span><span style="font-size: x-small;">]<br /> </span><span style="color: #0000ff; font-size: x-small;">public</span><span style="font-size: x-small;"> </span><span style="color: #0000ff; font-size: x-small;">static</span><span style="font-size: x-small;"> </span><span style="color: #2b91af; font-size: x-small;">InfoBoxData</span><span style="font-size: x-small;"> GetInfoBoxData(</span><span style="color: #0000ff; font-size: x-small;">int</span><span style="font-size: x-small;"> id)<br /> {<br /> </span><span style="color: #008000; font-size: x-small;"><span style="color: #0000ff;">&nbsp;&nbsp;&nbsp; </span>// Pass back the InfoBoxData<br /> </span><span style="color: #2b91af; font-size: x-small;"><span style="color: #0000ff;">&nbsp;&nbsp;&nbsp; </span>InfoBoxData</span><span style="font-size: x-small;"> data = </span><span style="color: #0000ff; font-size: x-small;">new</span><span style="font-size: x-small;"> </span><span style="color: #2b91af; font-size: x-small;">InfoBoxData</span><span style="font-size: x-small;">();<br /> <span style="color: #0000ff;">&nbsp;&nbsp;&nbsp; </span>data.Title = </span><span style="color: #a31515; font-size: x-small;">"Item "</span><span style="font-size: x-small;"> + id.ToString();<br /> </span><span style="color: #008000; font-size: x-small;"><span style="color: #0000ff;">&nbsp;&nbsp;&nbsp; </span>// Get the HTML to be displayed within the Description field<br /> </span><span style="font-size: x-small;"><span style="color: #0000ff;">&nbsp;&nbsp;&nbsp; </span>data.Description = </span><span style="color: #2b91af; font-size: x-small;">ViewManager</span><span style="font-size: x-small;">.RenderView(</span><span style="color: #a31515; font-size: x-small;">"~/App_Views/InfoBoxDescription.ascx"</span><span style="font-size: x-small;">, id);<br /> </span><span style="color: #0000ff; font-size: x-small;">&nbsp;&nbsp;&nbsp; return</span><span style="font-size: x-small;"> data;<br /> </span><span style="font-size: x-small;">}</span></p>
</span></p>
<p><strong>Step 3: </strong>Add the ViewManager class to the site's App_Code folder. This class will be used within the GetInfoBoxData Page Method to render the Description from a UserControl Template. This class was written by Scott Guthrie in his post titled "<a href="http://weblogs.asp.net/scottgu/archive/2006/10/22/Tip_2F00_Trick_3A00_-Cool-UI-Templating-Technique-to-use-with-ASP.NET-AJAX-for-non_2D00_UpdatePanel-scenarios.aspx">Tip/Trick: Cool UI Templating Technique to use with ASP.NET AJAX for non-UpdatePanel scenarios</a>", and it works perfect in this scenario.</p>
<p><span style="color: #0000ff; font-size: x-small;">
<p>public<span style="font-size: x-small;"> </span><span style="color: #0000ff; font-size: x-small;">class</span><span style="font-size: x-small;"> </span><span style="color: #2b91af; font-size: x-small;">ViewManager<br /> </span><span style="font-size: x-small;">{<br /> </span><span style="color: #0000ff; font-size: x-small;">&nbsp;&nbsp;&nbsp; public</span><span style="font-size: x-small;"> </span><span style="color: #0000ff; font-size: x-small;">static</span><span style="font-size: x-small;"> </span><span style="color: #0000ff; font-size: x-small;">string</span><span style="font-size: x-small;"> RenderView(</span><span style="color: #0000ff; font-size: x-small;">string</span><span style="font-size: x-small;"> path)<br /> <span style="color: #0000ff;">&nbsp;&nbsp;&nbsp; </span>{<br /> </span><span style="color: #0000ff; font-size: x-small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return</span><span style="font-size: x-small;"> RenderView(path, </span><span style="color: #0000ff; font-size: x-small;">null</span><span style="font-size: x-small;">);<br /> <span style="color: #0000ff;">&nbsp;&nbsp;&nbsp;&nbsp;</span>}<br /> </span><span style="color: #0000ff; font-size: x-small;">&nbsp;&nbsp;&nbsp; public</span><span style="font-size: x-small;"> </span><span style="color: #0000ff; font-size: x-small;">static</span><span style="font-size: x-small;"> </span><span style="color: #0000ff; font-size: x-small;">string</span><span style="font-size: x-small;"> RenderView(</span><span style="color: #0000ff; font-size: x-small;">string</span><span style="font-size: x-small;"> path, </span><span style="color: #0000ff; font-size: x-small;">object</span><span style="font-size: x-small;"> data)<br /> <span style="color: #0000ff;">&nbsp;&nbsp;&nbsp; </span>{<br /> </span><span style="color: #2b91af; font-size: x-small;"><span style="color: #0000ff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Page</span><span style="font-size: x-small;"> pageHolder = </span><span style="color: #0000ff; font-size: x-small;">new</span><span style="font-size: x-small;"> </span><span style="color: #2b91af; font-size: x-small;">Page</span><span style="font-size: x-small;">();<br /> </span><span style="color: #2b91af; font-size: x-small;"><span style="color: #0000ff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>UserControl</span><span style="font-size: x-small;"> viewControl = (</span><span style="color: #2b91af; font-size: x-small;">UserControl</span><span style="font-size: x-small;">)pageHolder.LoadControl(path);<br /> </span><span style="color: #0000ff; font-size: x-small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if</span><span style="font-size: x-small;"> (data != </span><span style="color: #0000ff; font-size: x-small;">null</span><span style="font-size: x-small;">)<br /> <span style="color: #0000ff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>{<br /> </span><span style="color: #2b91af; font-size: x-small;"><span style="color: #0000ff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Type</span><span style="font-size: x-small;"> viewControlType = viewControl.GetType();<br /> </span><span style="color: #2b91af; font-size: x-small;"><span style="color: #0000ff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>FieldInfo</span><span style="font-size: x-small;"> field = viewControlType.GetField(</span><span style="color: #a31515; font-size: x-small;">"Data"</span><span style="font-size: x-small;">);<br /> </span><span style="color: #0000ff; font-size: x-small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if</span><span style="font-size: x-small;"> (field != </span><span style="color: #0000ff; font-size: x-small;">null</span><span style="font-size: x-small;">)<br /> <span style="color: #0000ff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>{<br /> <span style="color: #0000ff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>field.SetValue(viewControl, data);<br /> <span style="color: #0000ff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}<br /> </span><span style="color: #0000ff; font-size: x-small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<br /> </span><span style="font-size: x-small;"><span style="color: #0000ff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>{<br /> </span><span style="color: #0000ff; font-size: x-small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw</span><span style="font-size: x-small;"> </span><span style="color: #0000ff; font-size: x-small;">new</span><span style="font-size: x-small;"> </span><span style="color: #2b91af; font-size: x-small;">Exception</span><span style="font-size: x-small;">(</span><span style="color: #a31515; font-size: x-small;">"View file: "</span><span style="font-size: x-small;"> + path + </span><span style="color: #a31515; font-size: x-small;">" does not have a public Data property"</span><span style="font-size: x-small;">);<br /> <span style="color: #0000ff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}<br /> <span style="color: #0000ff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}<br /> <span style="color: #0000ff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>pageHolder.Controls.Add(viewControl);<br /> </span><span style="color: #2b91af; font-size: x-small;"><span style="color: #0000ff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>StringWriter</span><span style="font-size: x-small;"> output = </span><span style="color: #0000ff; font-size: x-small;">new</span><span style="font-size: x-small;"> </span><span style="color: #2b91af; font-size: x-small;">StringWriter</span><span style="font-size: x-small;">();<br /> </span><span style="color: #2b91af; font-size: x-small;"><span style="color: #0000ff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>HttpContext</span><span style="font-size: x-small;">.Current.Server.Execute(pageHolder, output, </span><span style="color: #0000ff; font-size: x-small;">false</span><span style="font-size: x-small;">);<br /> </span><span style="color: #0000ff; font-size: x-small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return</span><span style="font-size: x-small;"> output.ToString();<br /> <span style="color: #0000ff;">&nbsp;&nbsp;&nbsp; </span>}<br /> }</span></p>
</span></p>
<p><strong>Step 4: </strong>Create our InfoBoxDescription UserControl that the GetInfoBoxData Page Method will use as a template for rendering the Description.</p>
<p><span style="font-size: x-small;">
<p>&lt;%<span style="color: #0000ff; font-size: x-small;">@</span><span style="font-size: x-small;"> </span><span style="color: #a31515; font-size: x-small;">Control</span><span style="font-size: x-small;"> </span><span style="color: #ff0000; font-size: x-small;">Language</span><span style="color: #0000ff; font-size: x-small;">="C#"</span><span style="font-size: x-small;"> </span><span style="color: #ff0000; font-size: x-small;">AutoEventWireup</span><span style="color: #0000ff; font-size: x-small;">="true"</span><span style="font-size: x-small;"> </span><span style="color: #ff0000; font-size: x-small;">CodeFile</span><span style="color: #0000ff; font-size: x-small;">="InfoBoxDescription.ascx.cs"</span><span style="font-size: x-small;"> </span><span style="color: #ff0000; font-size: x-small;">Inherits</span><span style="color: #0000ff; font-size: x-small;">="App_Views_InfoBoxDescription"</span><span style="font-size: x-small;"> %&gt;<br /> This is the description for </span><span style="color: #0000ff; font-size: x-small;">&lt;</span><span style="color: #a31515; font-size: x-small;">strong</span><span style="color: #0000ff; font-size: x-small;">&gt;</span><span style="font-size: x-small;">Item &lt;%</span><span style="color: #0000ff; font-size: x-small;">=this</span><span style="font-size: x-small;">.Data.ToString()%&gt;</span><span style="color: #0000ff; font-size: x-small;">&lt;/</span><span style="color: #a31515; font-size: x-small;">strong</span><span style="color: #0000ff; font-size: x-small;">&gt;</span><span style="font-size: x-small;">.</span><span style="color: #0000ff; font-size: x-small;">&lt;</span><span style="color: #a31515; font-size: x-small;">br</span><span style="font-size: x-small;"> </span><span style="color: #0000ff; font-size: x-small;">/&gt;<br /> </span><span style="font-size: x-small;">This description was generated dynamically using a UserControl.</span></p>
</span><span style="color: #0000ff; font-size: x-small;">
<p>public<span style="font-size: x-small;"> </span><span style="color: #0000ff; font-size: x-small;">partial</span><span style="font-size: x-small;"> </span><span style="color: #0000ff; font-size: x-small;">class</span><span style="font-size: x-small;"> </span><span style="color: #2b91af; font-size: x-small;">App_Views_InfoBoxDescription</span><span style="font-size: x-small;"> : System.Web.UI.</span><span style="color: #2b91af; font-size: x-small;">UserControl<br /> </span><span style="font-size: x-small;">{<br /> </span><span style="color: #0000ff; font-size: x-small;">&nbsp;&nbsp;&nbsp; public</span><span style="font-size: x-small;"> </span><span style="color: #0000ff; font-size: x-small;">int</span><span style="font-size: x-small;"> Data;<br /> </span><span style="color: #0000ff; font-size: x-small;">&nbsp;&nbsp;&nbsp; protected</span><span style="font-size: x-small;"> </span><span style="color: #0000ff; font-size: x-small;">void</span><span style="font-size: x-small;"> Page_Load(</span><span style="color: #0000ff; font-size: x-small;">object</span><span style="font-size: x-small;"> sender, </span><span style="color: #2b91af; font-size: x-small;">EventArgs</span><span style="font-size: x-small;"> e)<br /> <span style="color: #0000ff;">&nbsp;&nbsp;&nbsp; </span>{<br /> <span style="color: #0000ff;">&nbsp;&nbsp;&nbsp; </span>}<br /> }</span></p>
</span></p>
<p><strong>Step 5:</strong>&nbsp; Attach a JavaScript method to the VE Maps OnMouseMove event, just after the code that instantiates the map.</p>
<p><span style="font-size: x-small;">
<p>map.AttachEvent(<span style="color: #a31515; font-size: x-small;">"onmousemove"</span><span style="font-size: x-small;">, MapMouseMove);</span></p>
</span></p>
<p><strong>Step 6: </strong>Write code in the OnMouseMove event handler to fire off the GetInfoBoxData Page Method to load the Shapes Title and Description.</p>
<p><span style="color: #0000ff; font-size: x-small;">
<p>function<span style="font-size: x-small;"> MapMouseMove(e)<br /> {<br /> </span><span style="color: #0000ff; font-size: x-small;">&nbsp;&nbsp;&nbsp; if</span><span style="font-size: x-small;"> (e.elementID != </span><span style="color: #0000ff; font-size: x-small;">null</span><span style="font-size: x-small;">)<br /> <span style="color: #0000ff;">&nbsp;&nbsp;&nbsp; </span>{<br /> </span><span style="color: #0000ff; font-size: x-small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var</span><span style="font-size: x-small;"> shape = map.GetShapeByID(e.elementID);<br /> <br /> </span><span style="color: #008000; font-size: x-small;"><span style="color: #0000ff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>// Check if the Shapes been loaded already<br /> </span><span style="color: #0000ff; font-size: x-small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if</span><span style="font-size: x-small;"> (shape.GetTitle().indexOf(</span><span style="color: #a31515; font-size: x-small;">"LOAD:"</span><span style="font-size: x-small;">) != -1)<br /> <span style="color: #0000ff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>{<br /> </span><span style="color: #008000; font-size: x-small;"><span style="color: #0000ff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>// Get our ID for the Shape from within the Shapes Title<br /> </span><span style="color: #0000ff; font-size: x-small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var</span><span style="font-size: x-small;"> id = parseInt(shape.GetTitle().substring(5));<br /> <br /> </span><span style="color: #008000; font-size: x-small;"><span style="color: #0000ff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>// Set the Shape to display a loading message<br /> </span><span style="font-size: x-small;"><span style="color: #0000ff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>shape.SetTitle(</span><span style="color: #a31515; font-size: x-small;">"Loading..."</span><span style="font-size: x-small;">);<br /> </span><span style="color: #008000; font-size: x-small;"><br /> <span style="color: #0000ff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>// Fire off the loading of the InfoBox Data<br /> </span><span style="font-size: x-small;"><span style="color: #0000ff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>PageMethods.GetInfoBoxData(id, </span><span style="color: #008000; font-size: x-small;">/* &lt;-- Pass the WebMethod its parameters */<br /> </span><span style="font-size: x-small;"><span style="color: #0000ff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>InfoBoxDataLoaded, </span><span style="color: #008000; font-size: x-small;">/* &lt;-- The callback method that gets called when the Page Method call Succeeds */<br /> </span><span style="font-size: x-small;"><span style="color: #0000ff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>InfoBoxDataLoadError, </span><span style="color: #008000; font-size: x-small;">/* &lt;-- The callback method that gets called if the Page Method Fails */<br /> </span><span style="font-size: x-small;"><span style="color: #0000ff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>shape </span><span style="color: #008000; font-size: x-small;">/* &lt;-- Pass the Shape as our Context value to the callback method */<br /> </span><span style="font-size: x-small;"><span style="color: #0000ff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>);<br /> <span style="color: #0000ff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}<br /> &nbsp;&nbsp;&nbsp; }<br /> }</span></p>
</span></p>
<p><strong>Step 7: </strong>Add our success callback method, that the call to GetInfoBoxData will call once the data has been recieved in the client.</p>
<p><span style="color: #0000ff; font-size: x-small;">
<p>function<span style="font-size: x-small;"> InfoBoxDataLoaded(result, context, methodName)<br /> {<br /> </span><span style="color: #0000ff; font-size: x-small;">&nbsp;&nbsp;&nbsp; var</span><span style="font-size: x-small;"> shape = context;<br /> </span><span style="color: #008000; font-size: x-small;">&nbsp;&nbsp;&nbsp; // Set the Shapes new Title and Description<br /> </span><span style="font-size: x-small;"><span style="color: #008000;">&nbsp;&nbsp;&nbsp; </span>shape.SetTitle(result.Title);<br /> <span style="color: #008000;">&nbsp;&nbsp;&nbsp; </span>shape.SetDescription(result.Description);<br /> </span><span style="color: #008000; font-size: x-small;">&nbsp;&nbsp;&nbsp; // Re-Show the InfoBox so the new Title and Description are automatically displayed<br /> </span><span style="font-size: x-small;"><span style="color: #008000;">&nbsp;&nbsp;&nbsp; </span>map.ShowInfoBox(shape);<br /> }</span></p>
</span></p>
<p><strong>Step 8: </strong>Add our failure callback method, that the call to GetInfoBoxData will call if it fails.</p>
<p><span style="color: #0000ff; font-size: x-small;">
<p>function<span style="font-size: x-small;"> InfoBoxDataLoadError(error)<br /> </span><span style="font-size: x-small;">{<br /> &nbsp;&nbsp;&nbsp; alert(</span><span style="color: #a31515; font-size: x-small;">"Error Occurred Loading InfoBox Data\n"</span><span style="font-size: x-small;"> + error.get_message());<br /> }</span></p>
</span></p>
<h3>Conclusion</h3>
<p>You'll no longer need to pass the full Title and Description for every Pushpin Shape you plot using this technique. You also&nbsp;be able to save bandwidth, and improve load times in your Virtual Earth implementations.</p>
<p><a href="/Download/Blog/1448/AjaxDynamicInfoBox.zip">Download Full Code For This Article Here</a></p>
